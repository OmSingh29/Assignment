{% extends "sales/base.html" %}

{% block content %}
<form method="get" class="space-y-4">
  <!-- Top bar: search + sort + apply -->
  <div class="flex flex-col md:flex-row gap-4 items-start md:items-end">
    <!-- Search -->
    <div class="flex-1">
      <label class="block text-sm font-medium mb-1">Search</label>
      <input
        type="text"
        name="q"
        value="{{ search_query }}"
        placeholder="Name, Phone no."
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
    </div>

    <!-- Sort -->
    <div>
      <label class="block text-sm font-medium mb-1">Sort by</label>
      <select
        name="sort"
        class="rounded-md bg-slate-900 border border-slate-700 px-3 py-2 text-sm"
      >
        <option value="date_desc" {% if sort_by == "date_desc" %}selected{% endif %}>
          Date (Newest first)
        </option>
        <option value="date_asc" {% if sort_by == "date_asc" %}selected{% endif %}>
          Date (Oldest first)
        </option>
        <option value="quantity_desc" {% if sort_by == "quantity_desc" %}selected{% endif %}>
          Quantity (High → Low)
        </option>
        <option value="quantity_asc" {% if sort_by == "quantity_asc" %}selected{% endif %}>
          Quantity (Low → High)
        </option>
        <option value="name_asc" {% if sort_by == "name_asc" %}selected{% endif %}>
          Customer Name (A–Z)
        </option>
        <option value="name_desc" {% if sort_by == "name_desc" %}selected{% endif %}>
          Customer Name (Z–A)
        </option>
      </select>
    </div>

    <!-- Apply button -->
    <div>
      <button
        type="submit"
        class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium hover:bg-indigo-500"
      >
        Apply
      </button>
    </div>
  </div>

  <!-- Filters panel -->
  <div class="grid md:grid-cols-3 gap-4 pt-4 border-t border-slate-800 mt-4">
    <!-- Customer Region (multi-select) -->
    <div>
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
        Customer Region
      </label>
      <select
        name="region"
        multiple
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs h-24"
      >
        {% for value in region_options %}
          <option value="{{ value }}"
            {% if value in selected_regions %}selected{% endif %}>
            {{ value }}
          </option>
        {% endfor %}
      </select>
      <p class="mt-1 text-[10px] text-slate-400">Ctrl/⌘ + click to multi-select</p>
    </div>

    <!-- Gender (multi-select) -->
    <div>
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
        Gender
      </label>
      <select
        name="gender"
        multiple
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs h-24"
      >
        {% for value in gender_options %}
          <option value="{{ value }}"
            {% if value in selected_genders %}selected{% endif %}>
            {{ value }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Age range -->
    <div class="flex gap-2">
      <div class="flex-1">
        <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
          Age min
        </label>
        <input
          type="number"
          name="age_min"
          value="{{ request.GET.age_min }}"
          class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
        />
      </div>
      <div class="flex-1">
        <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
          Age max
        </label>
        <input
          type="number"
          name="age_max"
          value="{{ request.GET.age_max }}"
          class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
        />
      </div>
    </div>

    <!-- Product category (multi-select) -->
    <div>
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
        Product Category
      </label>
      <select
        name="category"
        multiple
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs h-24"
      >
        {% for value in category_options %}
          <option value="{{ value }}"
            {% if value in selected_categories %}selected{% endif %}>
            {{ value }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Tags (multi-select) -->
    <div>
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
        Tags
      </label>
      <select
        name="tags"
        multiple
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs h-24"
      >
        {% for value in tag_options %}
          <option value="{{ value }}"
            {% if value in selected_tags %}selected{% endif %}>
            {{ value }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Payment method (multi-select) -->
    <div>
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
        Payment Method
      </label>
      <select
        name="payment_method"
        multiple
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs h-24"
      >
        {% for value in payment_method_options %}
          <option value="{{ value }}"
            {% if value in selected_payment_methods %}selected{% endif %}>
            {{ value }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Date range (kept as calendar inputs) -->
    <div>
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
        Date From
      </label>
      <input
        type="date"
        name="date_from"
        value="{{ request.GET.date_from }}"
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
      />
    </div>
    <div>
      <label class="block text-xs font-semibold mb-1 uppercase tracking-wide">
        Date To
      </label>
      <input
        type="date"
        name="date_to"
        value="{{ request.GET.date_to }}"
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
      />
    </div>
  </div>
</form>

<!-- Results table -->
<div class="mt-6 bg-slate-900/70 border border-slate-800 rounded-xl overflow-hidden">
  <table class="min-w-full text-xs">
    <thead class="bg-slate-900/90 border-b border-slate-800">
      <tr class="text-left">
        <th class="px-3 py-2 font-semibold">Date</th>
        <th class="px-3 py-2 font-semibold">Customer</th>
        <th class="px-3 py-2 font-semibold">Phone</th>
        <th class="px-3 py-2 font-semibold">Region</th>
        <th class="px-3 py-2 font-semibold">Product</th>
        <th class="px-3 py-2 font-semibold text-right">Qty</th>
        <th class="px-3 py-2 font-semibold text-right">Final Amount</th>
      </tr>
    </thead>
    <tbody>
      {% if page_obj.object_list %}
        {% for sale in page_obj.object_list %}
          <tr class="border-t border-slate-800/60 hover:bg-slate-800/60">
            <td class="px-3 py-2 whitespace-nowrap">{{ sale.date }}</td>
            <td class="px-3 py-2">{{ sale.customer_name }}</td>
            <td class="px-3 py-2">{{ sale.phone_number }}</td>
            <td class="px-3 py-2">{{ sale.customer_region }}</td>
            <td class="px-3 py-2">{{ sale.product_name }}</td>
            <td class="px-3 py-2 text-right">{{ sale.quantity }}</td>
            <td class="px-3 py-2 text-right">{{ sale.final_amount }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="px-3 py-6 text-center text-sm text-slate-400">
            No results found. Try changing search or filters.
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Pagination (preserves ALL filters & search) -->
{% with request.GET.urlencode as querystring %}
<div class="mt-4 flex items-center justify-between text-xs text-slate-400">
  <div>
    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
  </div>
  <div class="space-x-2">
    {% if page_obj.has_previous %}
      <a
        href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}"
        class="px-3 py-1 border border-slate-700 rounded-md"
      >
        Previous
      </a>
    {% endif %}
    {% if page_obj.has_next %}
      <a
        href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}"
        class="px-3 py-1 border border-slate-700 rounded-md"
      >
        Next
      </a>
    {% endif %}
  </div>
</div>
{% endwith %}
{% endblock %}
