{% extends "sales/base.html" %}

{% block content %}
<form method="get" class="space-y-4">
  <!-- Top bar: search + sort + apply -->
  <div class="flex flex-col md:flex-row gap-4 items-start md:items-end">
    <!-- Search -->
    <div class="flex-1">
      <label class="block text-sm font-medium mb-1 text-slate-200">Search</label>
      <input
        type="text"
        name="q"
        value="{{ search_query }}"
        placeholder="Search by customer name or phone"
        class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
    </div>

    <!-- Sort -->
    <div>
      <label class="block text-sm font-medium mb-1 text-slate-200">Sort by</label>
      <select
        name="sort"
        class="rounded-md bg-slate-900 border border-slate-700 px-3 py-2 text-sm"
      >
        <option value="date_desc" {% if sort_by == "date_desc" %}selected{% endif %}>
          Date (Newest first)
        </option>
        <option value="date_asc" {% if sort_by == "date_asc" %}selected{% endif %}>
          Date (Oldest first)
        </option>
        <option value="quantity_desc" {% if sort_by == "quantity_desc" %}selected{% endif %}>
          Quantity (High → Low)
        </option>
        <option value="quantity_asc" {% if sort_by == "quantity_asc" %}selected{% endif %}>
          Quantity (Low → High)
        </option>
        <option value="name_asc" {% if sort_by == "name_asc" %}selected{% endif %}>
          Customer Name (A–Z)
        </option>
        <option value="name_desc" {% if sort_by == "name_desc" %}selected{% endif %}>
          Customer Name (Z–A)
        </option>
      </select>
    </div>

    <!-- Apply button -->
    <div>
      <button
        type="submit"
        class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium hover:bg-indigo-500"
      >
        Apply
      </button>
    </div>
  </div>

  <!-- FILTER PANEL -->
  <div class="bg-slate-900/70 border border-slate-800 rounded-xl mt-4 divide-y divide-slate-800">
    <!-- Customer Region -->
    <details class="group">
      <summary
        class="flex items-center justify-between px-4 py-3 text-xs font-semibold uppercase tracking-wide cursor-pointer select-none"
      >
        <span>Customer Region</span>
        <span class="flex items-center gap-2 text-[11px] text-slate-400">
          {% if selected_regions %}
            <span>
              {% for r in selected_regions %}
                {{ r }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </span>
          {% else %}
            <span>Any</span>
          {% endif %}
          <span class="transition-transform group-open:rotate-180">^</span>
        </span>
      </summary>
      <div class="px-4 pb-3 pt-1 max-h-40 overflow-y-auto space-y-1">
        {% for r in available_regions %}
          <label class="flex items-center gap-2 text-xs text-slate-200">
            <input
              type="checkbox"
              name="region"
              value="{{ r }}"
              class="rounded border-slate-600 bg-slate-900"
              {% if r in selected_regions %}checked{% endif %}
            />
            <span>{{ r }}</span>
          </label>
        {% empty %}
          <p class="text-xs text-slate-500">No region data available.</p>
        {% endfor %}
      </div>
    </details>

    <!-- Gender -->
    <details class="group">
      <summary
        class="flex items-center justify-between px-4 py-3 text-xs font-semibold uppercase tracking-wide cursor-pointer select-none"
      >
        <span>Gender</span>
        <span class="flex items-center gap-2 text-[11px] text-slate-400">
          {% if selected_genders %}
            <span>
              {% for g in selected_genders %}
                {{ g }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </span>
          {% else %}
            <span>Any</span>
          {% endif %}
          <span class="transition-transform group-open:rotate-180">^</span>
        </span>
      </summary>
      <div class="px-4 pb-3 pt-1 max-h-40 overflow-y-auto space-y-1">
        {% for g in available_genders %}
          <label class="flex items-center gap-2 text-xs text-slate-200">
            <input
              type="checkbox"
              name="gender"
              value="{{ g }}"
              class="rounded border-slate-600 bg-slate-900"
              {% if g in selected_genders %}checked{% endif %}
            />
            <span>{{ g }}</span>
          </label>
        {% empty %}
          <p class="text-xs text-slate-500">No gender data available.</p>
        {% endfor %}
      </div>
    </details>

    <!-- Age Range -->
    <details class="group">
      <summary
        class="flex items-center justify-between px-4 py-3 text-xs font-semibold uppercase tracking-wide cursor-pointer select-none"
      >
        <span>Age Range</span>
        <span class="flex items-center gap-2 text-[11px] text-slate-400">
          {% if request.GET.age_min or request.GET.age_max %}
            {{ request.GET.age_min|default:"0" }} – {{ request.GET.age_max|default:"∞" }}
          {% else %}
            Any
          {% endif %}
          <span class="transition-transform group-open:rotate-180">^</span>
        </span>
      </summary>
      <div class="px-4 pb-3 pt-1">
        <div class="flex gap-3">
          <div class="flex-1">
            <label class="block text-[11px] font-semibold mb-1 uppercase tracking-wide text-slate-300">
              Min
            </label>
            <input
              type="number"
              name="age_min"
              value="{{ request.GET.age_min }}"
              class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
            />
          </div>
          <div class="flex-1">
            <label class="block text-[11px] font-semibold mb-1 uppercase tracking-wide text-slate-300">
              Max
            </label>
            <input
              type="number"
              name="age_max"
              value="{{ request.GET.age_max }}"
              class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
            />
          </div>
        </div>
      </div>
    </details>

    <!-- Product Category -->
    <details class="group">
      <summary
        class="flex items-center justify-between px-4 py-3 text-xs font-semibold uppercase tracking-wide cursor-pointer select-none"
      >
        <span>Product Category</span>
        <span class="flex items-center gap-2 text-[11px] text-slate-400">
          {% if selected_categories %}
            <span>
              {% for c in selected_categories %}
                {{ c }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </span>
          {% else %}
            <span>Any</span>
          {% endif %}
          <span class="transition-transform group-open:rotate-180">^</span>
        </span>
      </summary>
      <div class="px-4 pb-3 pt-1 max-h-40 overflow-y-auto space-y-1">
        {% for c in available_categories %}
          <label class="flex items-center gap-2 text-xs text-slate-200">
            <input
              type="checkbox"
              name="category"
              value="{{ c }}"
              class="rounded border-slate-600 bg-slate-900"
              {% if c in selected_categories %}checked{% endif %}
            />
            <span>{{ c }}</span>
          </label>
        {% empty %}
          <p class="text-xs text-slate-500">No category data available.</p>
        {% endfor %}
      </div>
    </details>

    <!-- Payment Method -->
    <details class="group">
      <summary
        class="flex items-center justify-between px-4 py-3 text-xs font-semibold uppercase tracking-wide cursor-pointer select-none"
      >
        <span>Payment Method</span>
        <span class="flex items-center gap-2 text-[11px] text-slate-400">
          {% if selected_payment_methods %}
            <span>
              {% for pm in selected_payment_methods %}
                {{ pm }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </span>
          {% else %}
            <span>Any</span>
          {% endif %}
          <span class="transition-transform group-open:rotate-180">^</span>
        </span>
      </summary>
      <div class="px-4 pb-3 pt-1 max-h-40 overflow-y-auto space-y-1">
        {% for pm in available_payment_methods %}
          <label class="flex items-center gap-2 text-xs text-slate-200">
            <input
              type="checkbox"
              name="payment_method"
              value="{{ pm }}"
              class="rounded border-slate-600 bg-slate-900"
              {% if pm in selected_payment_methods %}checked{% endif %}
            />
            <span>{{ pm }}</span>
          </label>
        {% empty %}
          <p class="text-xs text-slate-500">No payment method data available.</p>
        {% endfor %}
      </div>
    </details>

    <!-- Date Range -->
    <details class="group">
      <summary
        class="flex items-center justify-between px-4 py-3 text-xs font-semibold uppercase tracking-wide cursor-pointer select-none"
      >
        <span>Date Range</span>
        <span class="flex items-center gap-2 text-[11px] text-slate-400">
          {% if request.GET.date_from or request.GET.date_to %}
            {{ request.GET.date_from|default:"Start" }} – {{ request.GET.date_to|default:"End" }}
          {% else %}
            Any
          {% endif %}
          <span class="transition-transform group-open:rotate-180">^</span>
        </span>
      </summary>
      <div class="px-4 pb-3 pt-1">
        <div class="flex gap-3">
          <div class="flex-1">
            <label class="block text-[11px] font-semibold mb-1 uppercase tracking-wide text-slate-300">
              From
            </label>
            <input
              type="date"
              name="date_from"
              value="{{ request.GET.date_from }}"
              class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
            />
          </div>
          <div class="flex-1">
            <label class="block text-[11px] font-semibold mb-1 uppercase tracking-wide text-slate-300">
              To
            </label>
            <input
              type="date"
              name="date_to"
              value="{{ request.GET.date_to }}"
              class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs"
            />
          </div>
        </div>
      </div>
    </details>

    <!-- Tags (multi-select with search, scroll, checkboxes) -->
    <details class="group">
      <summary
        class="flex items-center justify-between px-4 py-3 text-xs font-semibold uppercase tracking-wide cursor-pointer select-none"
      >
        <span>Tags</span>
        <span class="flex items-center gap-2 text-[11px] text-slate-400">
          {% if selected_tags %}
            <span>
              {% for t in selected_tags %}
                {{ t }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </span>
          {% else %}
            <span>Any</span>
          {% endif %}
          <span class="transition-transform group-open:rotate-180">^</span>
        </span>
      </summary>
      <div class="px-4 pb-3 pt-1 space-y-2">
        <input
          type="text"
          placeholder="Search tags..."
          class="w-full rounded-md bg-slate-900 border border-slate-700 px-3 py-1.5 text-xs mb-1"
          data-tag-filter-input
        />
        <div
          class="max-h-40 overflow-y-auto space-y-1"
          data-tag-options-container
        >
          {% for tag in available_tags %}
            <label
              class="flex items-center gap-2 text-xs text-slate-200"
              data-tag-option
              data-label="{{ tag|lower }}"
            >
              <input
                type="checkbox"
                name="tags"
                value="{{ tag }}"
                class="rounded border-slate-600 bg-slate-900"
                {% if tag in selected_tags %}checked{% endif %}
              />
              <span>{{ tag }}</span>
            </label>
          {% empty %}
            <p class="text-xs text-slate-500">No tags available.</p>
          {% endfor %}
        </div>
      </div>
    </details>
  </div>
</form>

<!-- Results table -->
<div class="mt-6 bg-slate-900/70 border border-slate-800 rounded-xl overflow-hidden">
  <table class="min-w-full text-xs">
    <thead class="bg-slate-900/90 border-b border-slate-800">
      <tr class="text-left">
        <th class="px-3 py-2 font-semibold">Date</th>
        <th class="px-3 py-2 font-semibold">Customer</th>
        <th class="px-3 py-2 font-semibold">Phone</th>
        <th class="px-3 py-2 font-semibold">Region</th>
        <th class="px-3 py-2 font-semibold">Product</th>
        <th class="px-3 py-2 font-semibold text-right">Qty</th>
        <th class="px-3 py-2 font-semibold text-right">Final Amount</th>
      </tr>
    </thead>
    <tbody>
      {% if page_obj.object_list %}
        {% for sale in page_obj.object_list %}
          <tr class="border-t border-slate-800/60 hover:bg-slate-800/60">
            <td class="px-3 py-2 whitespace-nowrap">{{ sale.date }}</td>
            <td class="px-3 py-2">{{ sale.customer_name }}</td>
            <td class="px-3 py-2">{{ sale.phone_number }}</td>
            <td class="px-3 py-2">{{ sale.customer_region }}</td>
            <td class="px-3 py-2">{{ sale.product_name }}</td>
            <td class="px-3 py-2 text-right">{{ sale.quantity }}</td>
            <td class="px-3 py-2 text-right">{{ sale.final_amount }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="px-3 py-6 text-center text-sm text-slate-400">
            No results found. Try changing search or filters.
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<div class="mt-4 flex items-center justify-between text-xs text-slate-400">
  <div>
    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
  </div>
  <div class="space-x-2">
    {% if page_obj.has_previous %}
      <a
        href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&sort={{ sort_by }}{% for r in selected_regions %}&region={{ r }}{% endfor %}{% for g in selected_genders %}&gender={{ g }}{% endfor %}{% for c in selected_categories %}&category={{ c }}{% endfor %}{% for pm in selected_payment_methods %}&payment_method={{ pm }}{% endfor %}{% if request.GET.age_min %}&age_min={{ request.GET.age_min }}{% endif %}{% if request.GET.age_max %}&age_max={{ request.GET.age_max }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% for t in selected_tags %}&tags={{ t }}{% endfor %}"
        class="px-3 py-1 border border-slate-700 rounded-md"
      >
        Previous
      </a>
    {% endif %}
    {% if page_obj.has_next %}
      <a
        href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&sort={{ sort_by }}{% for r in selected_regions %}&region={{ r }}{% endfor %}{% for g in selected_genders %}&gender={{ g }}{% endfor %}{% for c in selected_categories %}&category={{ c }}{% endfor %}{% for pm in selected_payment_methods %}&payment_method={{ pm }}{% endfor %}{% if request.GET.age_min %}&age_min={{ request.GET.age_min }}{% endif %}{% if request.GET.age_max %}&age_max={{ request.GET.age_max }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% for t in selected_tags %}&tags={{ t }}{% endfor %}"
        class="px-3 py-1 border border-slate-700 rounded-md"
      >
        Next
      </a>
    {% endif %}
  </div>
</div>

<!-- Small JS for tag search filter -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.querySelector("[data-tag-filter-input]");
    const container = document.querySelector("[data-tag-options-container]");
    if (!input || !container) return;

    input.addEventListener("input", () => {
      const q = input.value.toLowerCase();
      container.querySelectorAll("[data-tag-option]").forEach((row) => {
        const label = row.getAttribute("data-label") || "";
        row.style.display = label.includes(q) ? "" : "none";
      });
    });
  });
</script>
{% endblock %}
